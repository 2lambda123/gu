#!/bin/bash

# Determine if the terminal supports colors.
CAN_USE_COLOR=$(tput setaf 1 &> /dev/null && echo "1" || echo "0")

echo_with_colour() {
	if [[ $CAN_USE_COLOR -eq 1 ]]; then
		echo -e "$1$2\033[0m"
	else
		echo $2
	fi
}

log() {
	echo_with_colour "\033[2m" "$1"
}

error() {
	echo_with_colour "\033[31m" "$1"
}

GU_DIR="$(pwd)/scripts"

# If the .gu directory does not exist, exit with an error.
if [[ ! -d "$GU_DIR" ]]; then
	error "Tasks must live in ./.gu, but it does not exist."
	exit 1
fi

# Function that lists the available tasks in the .gu directory.
list_tasks() {
	log "Available tasks:"
	find "$GU_DIR" -type f \( -name "*.sh" -o -name "*.js" -o ! -name "*.*" \) | sort | while read -r filepath; do
		task=$(basename "$filepath" | sed -e 's/\.js$//' -e 's/\.sh$//')
		log "- $task"
	done
}


# If no arguments are passed, list the tasks and exit.
if [[ $# -eq 0 ]]; then
    list_tasks
    exit 0
fi

# Arrays to store tasks and their associated flags.
tasks=()
flags_list=()

# Current task and flags being processed.
current_task=""
current_flags=()

# Parse the command line arguments.
for arg in "$@"; do
	if [[ "$arg" == -* ]]; then
		if [[ -n $current_task ]]; then
			current_flags+=("$arg")
		fi
	else
		if [[ -n $current_task ]]; then
			tasks+=("$current_task")
			flags_list+=("${current_flags[*]}")
			current_flags=()
		fi
		current_task="$arg"
	fi
done

# Storing the last task and its flags after the loop.
if [[ -n $current_task ]]; then
	tasks+=("$current_task")
	flags_list+=("${current_flags[*]}")
fi

# Execute each task with its associated flags.
for idx in "${!tasks[@]}"; do
	task="${tasks[$idx]}"
	IFS=' ' read -ra flags_for_task <<< "${flags_list[$idx]}"

	JS_SCRIPT="$GU_DIR/$task.js"
	SH_SCRIPT="$GU_DIR/$task.sh"
	EXECUTABLE="$GU_DIR/$task"

	if [[ -f "$JS_SCRIPT" ]]; then
		node "$JS_SCRIPT" "${flags_for_task[@]}"
	elif [[ -f "$SH_SCRIPT" ]]; then
		bash "$SH_SCRIPT" "${flags_for_task[@]}"
	elif [[ -f "$EXECUTABLE" && ! "$task" =~ \..+$ ]]; then
		"$EXECUTABLE" "${flags_for_task[@]}"
	else
		error "No task found with the name \"$task\"."
		list_tasks
		exit 1
	fi
done
